{"version":3,"sources":["../src/worldmap_apica.js"],"names":["WorldMapOriginal","tileServers","url","attribution","subdomains","WorldMap","circle","locationName","value","unbindPopup","bindPopup","window","L","point","ctrl","panel","stickyLabels","Icon","Default","imagePath","markers","legend","control","position","mapCenter","latLng","parseFloat","mapCenterLatitude","mapCenterLongitude","map","mapContainer","worldCopyJump","center","fitWorld","zoomIn","parseInt","initialZoom","panTo","scrollWheelZoom","disable","selectedTileServer","tileServer","tileLayer","maxZoom","reuseTiles","detectRetina","addTo","data","self","markerClusterGroup","showCoverageOnHover","iconCreateFunction","cluster","getAllChildMarkers","severityClusterClass","getClassWithWorstSeverity","divIcon","html","length","className","iconSize","forEach","dataPoint","marker","CircleMarker","LatLng","locationLatitude","locationLongitude","radius","calcCircleSize","color","getColor","fillColor","fillOpacity","countBySeverity","createPopup","summary","valueRounded","push","addLayer","on","e","locationPopupPartials","total","i","w","f","u","getClusterFromLayer","children","layer","child","options","createLocationPopupPartial","label","createSummaryPopupPartial","openPopup","closePopup","markerLayer","off","removeLayer","name","needHr","hrBlock","target","getVisibleParent","totals"],"mappings":"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","file":"worldmap_apica.js","sourcesContent":["import WorldMapOriginal from './worldmap';\n\nconst tileServers = {\n  'CartoDB Positron': { url: 'https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', attribution: '&copy; <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a> &copy; <a href=\"http://cartodb.com/attributions\">CartoDB</a>', subdomains: 'abcd'},\n  'CartoDB Dark': {url: 'https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png', attribution: '&copy; <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a> &copy; <a href=\"http://cartodb.com/attributions\">CartoDB</a>', subdomains: 'abcd'}\n};\n\nexport default class WorldMap extends WorldMapOriginal {\n  // in table Location Data mode locationName is the value of the field which name is set in \"Table Label Field\".\n  // can be set to any field from table datasource, so we just show it instead of the original that shows more than we want.\n  createPopup(circle, locationName, value) {\n    super.createPopup(circle, locationName, value);\n    circle.unbindPopup();\n    circle.bindPopup(locationName, {'offset': window.L.point(0, -7), 'className': 'worldmap-popup', 'closeButton': this.ctrl.panel.stickyLabels});\n  }\n\n  createMap() {\n    window.L.Icon.Default.imagePath = 'public/img';\n    this.markers = [];\n    this.legend = window.L.control({position: 'bottomleft'});\n    const mapCenter = window.L.latLng(parseFloat(this.ctrl.panel.mapCenterLatitude), parseFloat(this.ctrl.panel.mapCenterLongitude));\n    this.map = window.L.map(this.mapContainer, {worldCopyJump: true, center: mapCenter})\n      .fitWorld()\n      .zoomIn(parseInt(this.ctrl.panel.initialZoom, 10));\n    this.map.panTo(mapCenter);\n    this.map.scrollWheelZoom.disable();\n\n    const selectedTileServer = tileServers[this.ctrl.tileServer];\n    window.L.tileLayer(selectedTileServer.url, {\n      maxZoom: 18,\n      subdomains: selectedTileServer.subdomains,\n      reuseTiles: true,\n      detectRetina: true,\n      attribution: selectedTileServer.attribution\n    }).addTo(this.map);\n  }\n\n  createCircles(data) {\n    var self = this;\n\n    var markers = window.L.markerClusterGroup({\n      showCoverageOnHover: false,\n      iconCreateFunction: function (cluster) {\n        var markers = cluster.getAllChildMarkers();\n        var severityClusterClass = self.getClassWithWorstSeverity(markers);\n\n        return L.divIcon({ html: `<div><span>${markers.length}</span></div>`, className: `leaflet-marker-icon marker-cluster ${severityClusterClass} leaflet-zoom-animated leaflet-clickable`, iconSize: L.point(40, 40) });\n      },\n    });\n    \n    data.forEach((dataPoint) => {\n      var marker = new window.L.CircleMarker(new window.L.LatLng(dataPoint.locationLatitude, dataPoint.locationLongitude), {\n        radius: this.calcCircleSize(dataPoint.value || 0),\n        color: this.getColor(dataPoint.value),\n        fillColor: this.getColor(dataPoint.value),\n        fillOpacity: 0.5,\n        locationName: dataPoint.locationName,\n        countBySeverity: dataPoint.countBySeverity\n      });\n\n      this.createPopup(marker, dataPoint.summary, dataPoint.valueRounded);\n\n      this.markers.push(markers.addLayer(marker));\n    });\n\n    \n\n\n    markers.on('clustermouseover', function(e) {\n      var locationPopupPartials = '';\n      var total = {i: 0, w: 0, e: 0, f: 0, u: 0, total: 0};\n      var cluster = self.getClusterFromLayer(e);\n      var children = e.layer.getAllChildMarkers();\n      \n      for (var i = 0; i < children.length; i++) {\n        var child = children[i];\n\n        child.options.countBySeverity.total = \n          child.options.countBySeverity.i + \n          child.options.countBySeverity.w + \n          child.options.countBySeverity.e + \n          child.options.countBySeverity.f + \n          child.options.countBySeverity.u;\n\n        locationPopupPartials += self.createLocationPopupPartial(child.options.locationName, child.options.countBySeverity, i < children.length - 1);\n\n        total.i += child.options.countBySeverity.i;\n        total.w += child.options.countBySeverity.w;\n        total.e += child.options.countBySeverity.e;\n        total.f += child.options.countBySeverity.f;\n        total.u += child.options.countBySeverity.u;\n        total.total += child.options.countBySeverity.total; \n      };\n\n      var label = '<div class=\"popup-content\">';\n      label += self.createSummaryPopupPartial('Summary', total);\n      label += locationPopupPartials\n      label += '</div>';\n\n      cluster.unbindPopup();\n      cluster.bindPopup(label, { 'offset': window.L.point(0, -20), 'className': 'worldmap-popup', 'closeButton': self.ctrl.panel.stickyLabels}).openPopup();\n    })\n\n    markers.on('clustermouseout', function(e) {\n      if (!self.ctrl.panel.stickyLabels) {\n        var cluster = self.getClusterFromLayer(e);\n    \t\n        cluster.closePopup();\n      }\n    })\n\n    this.markerLayer = this.map.addLayer(markers);\n  }\n\n  clearCircles() {\n    for (var i =0; i < this.markers.length; i++) {\n      this.markers[i].off('mouseover');\n      this.markers[i].off('mouseout');\n      this.map.removeLayer(this.markers[i]);\n    }\n\n    if (this.markerLayer) {\n      this.map.removeLayer(this.markerLayer);\n    }\n\n    this.markers = [];\n  }\n\n  createSummaryPopupPartial(name, total) {\n    return `<div class=\"summary-section\">\n              <div class=\"summary-section__name\">\n                ${name}\n              </div>\n              <div>\n                <span class=\"summary-section__description summary-section__description_total\">Total</span>\n                <span class=\"summary-section__description summary-section__description_information\">I</span>\n                <span class=\"summary-section__description summary-section__description_warning\">W</span>\n                <span class=\"summary-section__description summary-section__description_error\">E</span>\n                <span class=\"summary-section__description summary-section__description_fatal\">F</span>\n                <span class=\"summary-section__description summary-section__description_unknow\">U</span>\n              </div>\n              <div>\n                <span class=\"summary-section__severity summary-section__severity_total\">${total.total}</span>\n                <span class=\"summary-section__severity summary-section__severity_information\">${total.i}</span>\n                <span class=\"summary-section__severity summary-section__severity_warning\">${total.w}</span>\n                <span class=\"summary-section__severity summary-section__severity_error\">${total.e}</span>\n                <span class=\"summary-section__severity summary-section__severity_fatal\">${total.f}</span>\n                <span class=\"summary-section__severity summary-section__severity_unknow\">${total.u}</span>\n              </div>\n              <hr>\n            </div>`;\n  }\n\n  createLocationPopupPartial(name, total, needHr) {\n    var hrBlock = needHr ? '<hr>' : '';\n\n    return `<div class=\"location-section\">\n              <div class=\"location-section__name\">\n                ${name}\n              </div>\n              <div>\n                <span class=\"location-section__severity location-section__severity_total\">${total.total}</span>\n                <span class=\"location-section__severity location-section__severity_information\">${total.i}</span>\n                <span class=\"location-section__severity location-section__severity_warning\">${total.w}</span>\n                <span class=\"location-section__severity location-section__severity_error\">${total.e}</span>\n                <span class=\"location-section__severity location-section__severity_fatal\">${total.f}</span>\n                <span class=\"location-section__severity location-section__severity_unknow\">${total.u}</span>\n              </div>\n              ${hrBlock}\n            </div>`;\n  }\n\n  getClusterFromLayer(e) {\n    var marker = e.layer.getAllChildMarkers()[0];\n    \n    return e.target.getVisibleParent(marker);\n  }\n\n  getClassWithWorstSeverity(markers) {\n    var totals = {i: 0, w: 0, e: 0, f: 0, u: 0};\n    for (var i = 0; i < markers.length; i++) {\n      var countBySeverity = markers[i].options.countBySeverity;\n\n      totals.i += countBySeverity.i;\n      totals.w += countBySeverity.w;\n      totals.e += countBySeverity.e;\n      totals.f += countBySeverity.f;\n      totals.u += countBySeverity.u;\n    }\n\n    if (totals.f > 0) return 'marker-cluster_fatal';\n    if (totals.e > 0) return 'marker-cluster_error';\n    if (totals.w > 0) return 'marker-cluster_warning';\n    if (totals.i > 0) return 'marker-cluster_information';\n    if (totals.u > 0) return 'marker-cluster_unknown';\n\n    return '';\n  }\n}"]}